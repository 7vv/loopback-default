# LoopBack start

The project is generated by [LoopBack](http://loopback.io).

## step1
LoopBack cli install
-`npm install loopback-cli -g`

## step2
create LoopBack server
- `lb`

## step3
모델 종류
- Model                   `기본 빈 모델`
- PersistedModel          `데이터 베이스를 사용하는 API 모델 CRUD 제공`
- ACL                     `인증 모델`
- AccessToken             `인증 토큰 모델`
- Application
- Change
- Checkpoint

create LoopBack model
- `lb model`

## step4
서버 실행하기
- `node .` or `nodemon .`   <- 사용가능

## Model connect DataSource
모델을 DataSource에 연결하기.

- lb datasource `데이터 소스 설정`
- /server/model-config.json 에서 원하는 db key값에 datasource 연결
- datasource에 사용할 수 있는 함수 사용해보기 `ex) app.models.CoffeeShop.create, update 등등..`
- 예제 API
```
 app.models.abs.create([{
      name: 'Bel Cafe',
      city: 'Vancouver'
    }, {
      name: 'Three Bees Coffee House',
      city: 'San Mateo'
    }, {
      name: 'Caffe Artigiano',
      city: 'Vancouver'
    }], function(err, abss) {
      if (err) throw err;

      console.log('Models created: \n', abss);
    });
```

## Static 웹 페이지 추가하기
API 서버로만 사용할거라서 정적 웹 페이지가 필요없지만 언젠간 사용할거 같아서 작성

- /server/middleware.json 에다가 정의한다.
```
  "files": {
    "loopback#static": {
      "params": "$!../client"
    }
  },
```
- $! 문자는 해당 파일 경로 위치를 반환함
- /client/index.html 위치에 웹 페이지 파일 작성

추가로 부팅 스크립트를 이용해 사용자 정의 라우터를 만들 수 있다.
- /server/boot/routes.js 생성 routes.js는 임의로 정할 수 있다.
- 아래 코드 작성 Express 라우터랑 같아서 설명 생략

```
module.exports = function(app) {
  //Express 기반이라서 Express 형태로 사용하면 된다.
  app.get('/ping', function(req, res) {
    res.send('pong');
  });

  const api = app.loopback.Router();
  const user = app.loopback.Router();
  api.get('/', (req, res, next) => {
    res.send('this api')
  })

  api.get('/get', (req, res, next) => {
    res.send('this get api')
  })

  user.get('/', (req, res, next) => {
    res.send('this user')
  })

  user.get('/get', (req, res, next) => {
    res.send('this get user')
  })


  app.use('/user', user)
  app.use('/api', api);
}
```

## DataSource 마이그래이션 진행하기
여러가지 디비와 테이블, 스키마가 섞여 있는 경우도 마이그래이션 작업이 가능하다.

서로 다른 DB를 공통적으로 처리할 수 있다는 것을 느끼게 된다.

서버가 시작 될 때 작동해야 하기 때문에 `/server/boot`에 파일을 하나 생성해 준다.

async await를 사용해서 동기적으로 처리하는 예제 코드

`mar.js`
```
//DB 마이그레이션 작업
module.exports = async function (app) {
  const mongodb = app.dataSources.mongodb;
  const mysql = app.dataSources.mysql;

  //create reviews
  createReviews = async (reviewers, coffeeShops) => {
    return new Promise((resolve, reject) => {
      mongodb.automigrate('Review', (err) => {
        if (err) reject(err)
        const Review = app.models.Review;
        const DAY_IN_MILLISECONDS = 1000 * 60 * 60 * 24;
        Review.create([
          {
            date: Date.now() - (DAY_IN_MILLISECONDS * 4),
            rating: 5,
            comments: 'A very good coffee shop.',
            publisherId: reviewers[0].id,
            coffeeShopId: coffeeShops[0].id,
          }
        ], (err, doc) => {
          if (err) console.log('Create Review Error', err);
          resolve(doc);
        });
      });
    })
  }

  createCoffeShop = async () => {
    return new Promise((resolve, reject) => {
      mysql.automigrate('abs', err => {
        if (err) reject(err)

        const Abs = app.models.Abs;
        Abs.create([
          {
            name: 'Bel Cafe',
          },
          {
            name: 'Three Bees Coffee House',
          },
          {
            name: 'Caffe Artigiano',
          }
        ], (err, doc) => {
          if (err) console.log('Boot Mongodb marg Error', err)
          resolve(doc);
        });
      })
    })
  }

  createReviewer = async () => {
    return new Promise((resolve, reject) => {
      mongodb.automigrate('Reviewer', err => {
        if (err) reject(err)

        const Reviewer = app.models.Reviewer;

        Reviewer.create([
          {
            email: 'sungho@naver.com',
            password: '1270'
          }
        ], (err, doc) => {
          if (err) console.log('Boot Mysql marg Error', err)
          resolve(doc);
        });
      })
    })
  }




  const coffeDoc = await createCoffeShop();
  const reviewerDoc = await createReviewer();
  console.log('1', coffeDoc);
  console.log('2', reviewerDoc)
  console.log('created Two marg')
  const review = await createReviews(reviewerDoc, coffeDoc);
  console.log('3', review)
}

```




